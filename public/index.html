<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>My News</title>
	<meta name="description" content="My list of news.">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:regular,bold,italic,thin,light,bolditalic,black,medium&amp;lang=en">
	<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
	<link rel="stylesheet" href="https://code.getmdl.io/1.1.3/material.indigo-red.min.css" />
	<link rel="stylesheet" href="styles/main.css">
</head>
<body>
<div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
	<header class="mdl-layout__header mdl-shadow--4dp">
		<div class="mdl-layout-icon"></div>
		<div class="mdl-layout__header-row">
			<span class="mdl-layout__title">MyNews</span>
			<div class="mdl-layout-spacer"></div>
			<nav class="mdl-navigation mdl-layout--large-screen-only" id="menuTop">
				<a class="all mdl-navigation__link" href="#">All</a>
				<a class="category-template mdl-navigation__link" href="#" hidden></a>
			</nav>
		</div>
	</header>
	<div class="mdl-layout__drawer">
		<span class="mdl-layout__title">MyNews</span>
		<nav class="mdl-navigation" id="drawer">
			<a class="all mdl-navigation__link" href="#">All</a>
		</nav>
	</div>
	<main class="mdl-layout__content">
		<div class="section">
			<ul id="articlesList" class="mdl-list mdl-shadow--2dp">
				<li class="article article-template mdl-list__item mdl-grid" hidden>
					<div class="mdl-list__item-primary-content article-content">
						<div class="mdl-list__item-text-body article-text-wrapper">
							<div class="article-header">
								<span class="article-site-info"><img class="icon" src="" /></span><span class="article-date"></span>
							</div>
							<div class="article-title"></div>
							<div class="article-body"></div>
						</div>
						<div class="article-image-wrapper">
							<img class="img-responsive article-image" src="" />
						</div>
					</div>
				</li>
			</ul>
		</div>

		<!--<div class="loader">-->
			<!--<svg viewBox="0 0 32 32" width="32" height="32">-->
				<!--<circle id="spinner" cx="16" cy="16" r="14" fill="none"></circle>-->
			<!--</svg>-->
		<!--</div>-->
	</main>
</div>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.13.0/moment.js"></script>
<script defer src="https://code.getmdl.io/1.1.3/material.min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/core-js/2.1.4/core.min.js"></script>
<script src="//npmcdn.com/feathers-client@^1.0.0/dist/feathers.js"></script>
<script src="socket.io/socket.io.js"></script>
<script type="text/javascript">

(function() {

'use strict';

// --------------------------
// 		CONFIGURATION
// --------------------------

var socket = io();
var feathersApp = feathers();
feathersApp.configure(feathers.socketio(socket));

var categoryService = feathersApp.service('categories');
var articleService = feathersApp.service('articles');

var app = {
	isLoading: true,
	menuTop: document.getElementById('menuTop'),
	drawer: document.getElementById('drawer'),
	articlesList: document.getElementById('articlesList'),
	articleTemplate: document.querySelector('.article-template'),
	categoryTemplate: document.querySelector('.category-template'),
	spinner: document.querySelector('.loader'),
	categories: []
};

// --------------------------
// 		METHODS
// --------------------------

app.addCategory = function(category) {
	app.categories.push(category);
	var categoryLink = app.categoryTemplate.cloneNode(true);
	categoryLink.classList.remove('category-template');
	categoryLink.classList.add('link_'+category._id);
	categoryLink.textContent = category.displayName;
	categoryLink.removeAttribute('hidden');
	app.menuTop.appendChild(categoryLink);
	app.drawer.appendChild(categoryLink.cloneNode(true));
	document.querySelectorAll('.link_'+category._id).forEach(function(catLink) {
		catLink.addEventListener('click', function() {
			app.displayCategory(category);
		});
	});
};

app.displayCategory = function(category) {
	app.hideArticles();
	app.showArticles(category._id);
};

app.addArticle = function(article, isHidden = false) {
	var articleTag = app.articleTemplate.cloneNode(true);
	articleTag.classList.remove('article-template');
	articleTag.classList.add(article.category_id);
	articleTag.setAttribute('id', article._id);

	if (article.siteName) {
		articleTag.querySelector('.article-site-info').innerHTML += article.siteName;
	}

	if (article.siteIcon && article.siteIcon !== '') {
		articleTag.querySelector('.icon').setAttribute('src', article.siteIcon);
	}
	else {
		articleTag.querySelector('.icon').remove();
	}

	if (article.createdAt) {
		var datePublished = moment(article.createdAt, moment.ISO_8601);
		articleTag.querySelector('.article-date').textContent = datePublished.format('ddd, Do MMM YYYY - hh:mm');
	}

	if (article.titleHtml) {
		articleTag.querySelector('.article-title').innerHTML += article.titleHtml;
	}

	if (article.bodyHtml) {
		articleTag.querySelector('.article-body').innerHTML += article.bodyHtml;
	}

	if (article.image && article.image !== '') {
		articleTag.querySelector('.article-image').setAttribute('src', article.image);
	}

	articleTag.removeAttribute('hidden');

	if (isHidden) {
		articleTag.style.display = 'none';
	}

	app.articlesList.insertBefore(articleTag, app.articlesList.firstChild);
};

app.hideArticles = function(categoryClass = '') {
	if (categoryClass !== '') {
		categoryClass = '.'+categoryClass;
	}

	document.querySelectorAll('.article'+categoryClass).forEach(function(el) {
		el.style.display = 'none';
	});
};

app.showArticles = function(categoryClass = '') {
	if (categoryClass !== '') {
		categoryClass = '.'+categoryClass;
	}

	document.querySelectorAll('.article'+categoryClass).forEach(function(el) {
		el.style.display = '';
	});
};

// --------------------------
// 		EVENT LISTENERS
// --------------------------

document.querySelectorAll('.all').forEach(function(el) {
	el.addEventListener('click', function() {
		app.showArticles();
	});
});

categoryService.on('created', function(category) {
	app.addCategory(category);
});

articleService.on('created', function(article) {
	var isHidden = false;
	// Figure out if the article's category is currently displayed.
	var anArticleOfSameCategory = document.querySelector('.article.'+article.category_id);
	if (anArticleOfSameCategory) {
		if (anArticleOfSameCategory.style.display == 'none') {
			isHidden = true;
		}
	}

	app.addArticle(article, isHidden);
});

// --------------------------
// 		INIT
// --------------------------

categoryService.find({ query: { $sort: { displayName: 1Â }}}, function(error, result) {
	if (!result) {
		return;
	}

	result.forEach(function(cat) {
		app.addCategory(cat);
	});
});

articleService.find({ query: { $sort: { createdAt: 1 }}}, function(error, result) {
	if (!result) {
		return;
	}

	result.forEach(function(article) {
		app.addArticle(article);
	});
});

})();
</script>
</body>
</html>
